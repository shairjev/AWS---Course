<?php
// --- DATABASE CONFIGURATION ---
$servername = "localhost";
$username   = "app_user";
$password   = "App_User_2026!#"; // Use the strong password you created
$dbname     = "my_app_db";

// 1. Create connection
$conn = new mysqli($servername, $username, $password, $dbname);

// Check connection
if ($conn->connect_error) {
    die("<p style='color:red;'>Connection failed: " . $conn->connect_error . "</p>");
}

// 2. HANDLE DATA INSERTION (Security: Prepared Statements)
if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST['submit'])) {
    $user_name    = $_POST['name'];
    $user_message = $_POST['message'];

    // Prepare an insert statement
    $stmt = $conn->prepare("INSERT INTO guestbook (name, message) VALUES (?, ?)");
    $stmt->bind_param("ss", $user_name, $user_message); // "ss" means two strings

    if ($stmt->execute()) {
        echo "<p style='color:green;'>Message saved successfully!</p>";
    } else {
        echo "<p style='color:red;'>Error: " . $stmt->error . "</p>";
    }
    $stmt->close();
}

// 3. RETRIEVE DATA
$sql = "SELECT name, message, reg_date FROM guestbook ORDER BY reg_date DESC";
$result = $conn->query($sql);
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EC2 LAMP Stack Test</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; background-color: #f4f7f6; }
        .container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; }
        form { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #eee; }
        input[type="text"], textarea { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        input[type="submit"] { background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        input[type="submit"]:hover { background-color: #0056b3; }
        .message-card { background: #fff; border-left: 5px solid #007bff; padding: 15px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .meta { font-size: 0.8em; color: #888; margin-top: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h1>EC2 Guestbook</h1>
    
    <form method="post" action="">
        <label>Your Name:</label>
        <input type="text" name="name" required placeholder="Enter your name">
        
        <label>Message:</label>
        <textarea name="message" rows="4" required placeholder="Write something..."></textarea>
        
        <input type="submit" name="submit" value="Post Message">
    </form>

    <h2>Recent Posts</h2>
    <div id="messages">
        <?php
        if ($result->num_rows > 0) {
            while($row = $result->fetch_assoc()) {
                echo "<div class='message-card'>";
                echo "<strong>" . htmlspecialchars($row["name"]) . "</strong>: ";
                echo htmlspecialchars($row["message"]);
                echo "<div class='meta'>Posted on: " . $row["reg_date"] . "</div>";
                echo "</div>";
            }
        } else {
            echo "<p>No messages found. Be the first to post!</p>";
        }
        $conn->close();
        ?>
    </div>
</div>

</body>
</html>